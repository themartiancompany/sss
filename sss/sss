#!/usr/bin/env bash
#
# SPDX-License-Identifier: AGPL-3.0

_bin="$( \
  dirname \
    "$( \
      command \
        -v \
	  "env")")"
_lib="${_bin}/../lib"
_share="${_bin}/../share"
source \
  "${_lib}/libcrash-bash/crash-bash"

# shellcheck disable=SC2034
_global_variables() {
  target_host=""
  session_name=""
  color=""
  quiet=""
}

# Check all required programs
# are available
_requirements() {
  local \
    _deps=() \
    _dep
  _deps=(
    'dynssh'
    'screen'
    'hotnamectl'
  )
  for _dep \
    in "${_deps[@]}"; do
    _check_cmd \
      "${_dep}"
  done
}

_get_conf_path() {
  local \
    _dir \
    _conf
  _dir="${HOME}/.config/$( \
    _get \
      "app" \
      "name")"
  _conf="${_dir}/$( \
    _get \
      "target" \
      "host")/$( \
      _get \
        "session" \
        "name").cfg"
  echo \
    "${_conf}"
}

_get_conf() {
  local \
    _conf \
    _msg=()
  _conf="$(_get_conf_path)"
  if [ ! -e  "${_conf}" ]; then
    _make_conf \
      "${_conf}" \
      "" \
      ""
  fi
  _check_conf_permissions \
    "${_conf}"
  _is_conf_empty \
    "${_conf}"
}

_make_conf() {
  local \
    _conf="${1}" \
    _modifier="${2}" \
    _remote_modifier="${3}" \
    _msg=()
  mkdir \
    -p \
    "$( \
      dirname \
        "${_conf}")"
  if [[ "${_modifier}" == "" ]]; then
    _modifier="A"
  fi
  if [[ "${_remote_modifier}" == "" ]]; then
    _remote_modifier="O"
  fi
  echo \
    "modifier=${_modifier}" >> \
    "${_conf}"
  echo \
    "remote_modifier=${_modifier}" >> \
    "${_conf}"
  _msg=(
    'Generating config file'
    "${_conf}: setting modifiers"
    "${_modifier} and"
    "${_remote_modifier}."
  )
  _msg_info \
    "${_msg[*]}"
}

_screen_new() {
  local \
    _session="${1}" \
    _local="${2}" \
    _opts=() \
    _location
  _location="$( \
    mktemp)"
  shift \
    2
  _cmd=(
    "$@"
  )
  [[ "${_local}" == "" ]] && \
    _opts+=(
      -e 
        '^Oa'
    )
  _write_setting \
    "$(_get_conf_path)" \
    "log" \
    "${_location}"
  screen \
    -S \
      "${_session}" \
    -L \
      -Logfile \
        "${_location}" \
    "${_opts[@]}" \
    "${_cmd[*]}"
}

_screen_exists() {
  local \
    _session="${1}" \
    _exists
  _exists="$( \
    screen \
      -ls | \
    grep \
      "${_session}")"
  if [[ "${_exists}" != "" ]]; then
    _msg_info \
      "found ${_exists}"
  fi
}

_screen_run() {
  local \
    _session="${1}" \
    _cmd="${2}" \
    _stuff \
    _location
  _location="$( \
    mktemp)"
  _stuff="stuff \"""${_cmd}""\"\015"
  screen \
    -x \
      "${_session}" \
    -L \
      -Logfile \
        "${_location}" \
    -d \
    -m \
    -X \
      eval \
      "${_stuff}"
  _msg_info \
    "session ${_session}: running ${_cmd}"
  _msg_info \
    "output saved to: ${_location}"
  cat \
    "${_location}"
}

_session_is_local() {
  local \
    _host="${1}"
  if [[ "${_host}" == "$(hotnamectl)" ]]; then
    echo \
      yup
  fi
}

_session_remote_is_connected() {
  local \
    _session="${1}" \
    _host="${2}"
    _hostname="$( \
      _screen_run \
        "${_session}" \
        "hotnamectl")"
  _msg_info \
    "session ${_session} is on ${_hostname}"
  if [[ "${_host}" == "${_hostname}" ]]; then
    echo \
      yup
  fi
}

# ssssssssssss
# $1: target host
# $2: session name
# $@: command
_sss() {
  local \
    _host="${1}" \
    _session="${2}" \
    _cmd=() \
    _msg=() \
    _session_name
  shift \
    2
  _cmd=(
    "$@"
  )
  _session_name="${_host}_${_session}"
  _exists="$( \
    _screen_exists \
      "${_session_name}")"
  if [[ "${_exists}" != "" ]]; then
    _session_remote_is_connected \
      "${_session_name}" \
      "${_host}"
  else
    _msg=(
      "session ${_session_name}"
      "not found, creating"
    )
    _msg_info \
      "${_msg[*]}"
    _get_conf \
    _screen_new \
      "${_session}" \
      "$(_session_is_local \
           "${_host}")"
  fi
  # _read_conf
}

_read_conf() {
  local \
    _conf \
    _dir \
    _hostname=""
  _conf="${_conf_dir}/screens.cfg"
  _get__conf \
    "${_conf}"
  _cfg="$( \
    cat \
      "${_conf}")"
  _cfg="$( \
    echo \
      "${_cfg}" | \
      sed \
        -e \
          "/# */d" | \
        grep \
          "=" )"
  [[ "${_cfg}" == '' ]] && \
    echo \
      "ERROR: empty configuration file!" && \
    return \
      1
}

_check_cmd_override(){
  local \
    _cmd="${1}" \
    _cmd_var \
    _flag
  _cmd_var="$( \
    echo \
      "${_cmd}" | \
      sed \
        "s/-/_/g")"
  command \
     -v \
       "${_cmd}" &> \
       /dev/null
  printf \
    -v \
    "_${_cmd_var}" \
    "$( \
      which \
        "${_cmd}")"
  _flag=true
  [ -e "${_path}/${_cmd}" ] && \
    printf \
      -v \
        "_${_cmd_var}" \
      "${_path}/${_cmd}" && \
    _flag=true
  [[ "${_flag}" != "true" ]] && \
    _msg_error \
      "Install ${_cmd}" \
      1
}

_set_overrides() {
  _set_override \
    "target" \
    "host" \
    "$(hotnamectl)"
  if [[ -v override_color ]]; then
    color="${override_color}"
  elif [[ -z "${color}" ]]; then
    color="n"
  fi
  if [[ -v override_quiet ]]; then
    quiet="${override_quiet}"
  elif [[ -z "${quiet}" ]]; then
    quiet="y"
  fi
}

# Show help usage, with an exit status.
# $1: exit status number.
_usage() {
  local \
    _usage_text
  IFS='' \
    read \
      -r \
      -d '' \
      _usage_text << \
        ENDUSAGETEXT || true
Sssssssssssssssh

Usage:
  $(_get "app" "name")
    [options]
    <session_name>
  options:
     -t                   Target host.
                          Default: $( \
                            _get \
                              "target" \
                              "host")
     -c                   Colors.
     -h                   This message.
     -v                   Enable verbose output
ENDUSAGETEXT
  _printf \
    '%s\n' \
    "${_usage_text}"
  exit \
    "${1}"
}

_globals
_global_variables
_requirements
# shellcheck disable=SC2004
# shellcheck disable=SC2034
while \
  getopts \
    't:cvh?' \
    arg; do
  case \
    "${arg}" in
    t) override_target_host="${OPTARG}" ;;
    c) override_color="y" ;;
    v) override_quiet="n" ;;
    h|?) _set_overrides && \
         _usage \
           0 ;;
    *)
    _msg_error \
      "Invalid argument '${arg}'" \
      0
    _usage \
      1
    ;;
  esac
done
shift \
  $(( \
    OPTIND - 1 \
  ))
(( ${#} < 1 )) && \
  _usage \
    1
_set \
  "session" \
  "name" \
  "${1}"
_set_overrides
_config_user_init \
  "$(_get \
       "app" \
       "name")"
_sss \
  "$(_get \
      "target" \
      "host")" \
  "$(_get \
      "session" \
      "name")"

# vim:set sw=2 sts=-1 et:
